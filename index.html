<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <!-- 适配手机端，保证小屏幕正常显示 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>基金实时估值表</title>
    <style>
        /* 登录界面样式 */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.2);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-form h2 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 30px;
            font-size: 1.8rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            color: #00d4ff;
            font-weight: bold;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00d4ff 0%, #0088cc 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
            margin-top: 10px;
        }

        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        .login-error {
            color: #ff4757;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
    </style>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        /* 标题样式 */
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            font-size: 2.5rem;
            letter-spacing: 2px;
        }

        h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        h3 {
            color: #00d4ff;
            margin: 20px 0 15px;
            font-size: 1.2rem;
        }

        h4 {
            color: #00d4ff;
            margin: 15px 0 10px;
            font-size: 1rem;
        }

        /* 刷新按钮：醒目、悬停效果 */
        .refresh-btn {
            display: block;
            margin: 20px auto;
            padding: 12px 30px;
            background: linear-gradient(135deg, #00d4ff 0%, #0088cc 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        /* 表格样式：边框、隔行变色、居中 */
        .fund-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .fund-table th,
        .fund-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fund-table th {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 136, 204, 0.2) 100%);
            color: #00d4ff;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .fund-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        /* 涨跌色标：涨红跌绿，直观区分 */
        .rise {
            color: #ff4757;
            font-weight: bold;
        }

        .fall {
            color: #00ff88;
            font-weight: bold;
        }

        /* 详情按钮样式 */
        .detail-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #00d4ff 0%, #0088cc 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }

        .detail-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
        }

        /* 确认操作按钮样式 */
        .confirm-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        /* 操作类型选择框样式 */
        .operation-select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .operation-select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .operation-select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        /* 加载提示 */
        .loading {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 5px;
            color: #00d4ff;
            font-weight: bold;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 212, 255, 0.2);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: #00d4ff;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #ffffff;
        }

        /* 详情加载提示 */
        .loading-details {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 5px;
            color: #00d4ff;
        }

        /* 基金详情样式 */
        .fund-details {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #00d4ff;
        }

        .fund-details p {
            margin: 10px 0;
            font-size: 14px;
        }

        /* 持仓表格样式 */
        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .holdings-table th,
        .holdings-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .holdings-table th {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            font-weight: bold;
        }

        /* 持仓操作样式 */
        .holding-operations {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .operation-group {
            margin: 15px 0;
        }

        .operation-group label {
            display: block;
            margin-bottom: 5px;
            color: #00d4ff;
            font-weight: bold;
        }

        .operation-group select,
        .operation-group input[type="number"] {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            color: #ffffff;
            font-size: 14px;
        }

        .operation-group select:focus,
        .operation-group input[type="number"]:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .operation-group button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: linear-gradient(135deg, #00d4ff 0%, #0088cc 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .operation-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        /* 我的持仓部分 */
        #myHoldingsSection {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
        }

        /* 搜索框样式 */
        .search-section {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .search-section h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #00d4ff;
            font-size: 18px;
        }

        .search-container {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
        }

        .search-container input {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            color: #ffffff;
        }

        .search-container input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .search-container button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #00d4ff 0%, #0088cc 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .search-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 5px;
            display: none;
            background: rgba(255, 255, 255, 0.05);
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .search-result-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-code {
            font-weight: bold;
            margin-right: 10px;
            color: #00d4ff;
        }

        .search-result-name {
            color: #e0e0e0;
        }

        .add-fund-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc66 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
        }

        .add-fund-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 255, 136, 0.3);
        }

        /* 响应式设计 */
        @media screen and (max-width: 1200px) {

            .fund-table th,
            .fund-table td {
                padding: 10px;
                font-size: 14px;
            }
        }

        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }

            /* 表格响应式处理 */
            .fund-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .fund-table::-webkit-scrollbar {
                height: 8px;
            }

            .fund-table::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
            }

            .fund-table::-webkit-scrollbar-thumb {
                background: rgba(0, 212, 255, 0.5);
                border-radius: 10px;
            }

            .fund-table::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 212, 255, 0.7);
            }

            .search-container {
                flex-direction: column;
            }

            .search-container button {
                width: 100%;
            }

            .holdings-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }

        @media screen and (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }

            .modal-content {
                padding: 15px;
            }

            .fund-details {
                padding: 15px;
            }

            .fund-details p {
                font-size: 13px;
            }

            .holding-operations {
                padding: 15px;
            }

            .operation-group input[type="number"] {
                font-size: 13px;
            }

            /* 小屏幕：表格卡片化显示，隐藏表头，增加可触控区域 */
            .fund-table thead {
                display: none;
            }

            .fund-table,
            .fund-table tbody {
                display: block;
                width: 100%;
            }

            .fund-table tr {
                display: block;
                margin-bottom: 12px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 8px;
                padding: 8px 10px;
            }

            .fund-table td {
                display: flex;
                justify-content: space-between;
                padding: 8px 6px;
                border-bottom: none;
                text-align: left;
            }

            .fund-table td::before {
                content: attr(data-label);
                color: #00d4ff;
                font-weight: 600;
                margin-right: 8px;
                flex: 0 0 auto;
            }

            .fund-table td span {
                flex: 1 1 auto;
                text-align: right;
            }

            .fund-table td button {
                flex: 0 0 auto;
                margin-left: 8px;
                text-align: center;
                min-width: 72px;
            }

            /* 底部刷新按钮固定显示，避免被遮挡并防止点击时偏移 */
            .refresh-btn {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: 12px;
                width: auto;
                max-width: 600px;
                margin: 0 auto;
                z-index: 2000;
                padding: 14px 20px;
                border-radius: 999px;
                outline: none;
                -webkit-tap-highlight-color: transparent;
            }

            .refresh-btn:focus,
            .refresh-btn:active {
                outline: none;
                box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
            }

            body {
                padding-bottom: 84px;
            }

            /* 搜索框和按钮更大，方便触控 */
            .search-container input {
                padding: 14px;
                font-size: 16px;
            }

            .search-container button {
                padding: 14px;
                font-size: 16px;
                width: 100%;
            }

            .detail-btn {
                padding: 10px 14px;
            }
        }
    </style>
</head>

<body>
    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>实时估值查询系统</h2>
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" placeholder="请输入用户名">
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="请输入密码">
            </div>
            <button onclick="login()">登录</button>
            <div class="login-error" id="loginError">用户名或密码错误</div>
        </div>
    </div>

    <h1>我的基金实时估值表</h1>
    <!-- 搜索框 -->
    <div class="search-section">
        <h2>添加基金</h2>
        <div class="search-container">
            <input type="text" id="fundSearch" placeholder="请输入基金代码或名称">
            <button onclick="searchFunds()">搜索</button>
        </div>
        <div class="search-results" id="searchResults">
            <!-- 搜索结果将在这里显示 -->
        </div>
    </div>
    <!-- 刷新按钮 -->
    <button class="refresh-btn" onclick="refreshData()">刷新估值</button>
    <!-- 加载提示 -->
    <div class="loading" id="loading">刷新数据中...</div>
    <!-- 基金估值表格 -->
    <table class="fund-table" id="fundTable" style="display: none">
        <thead>
            <tr>
                <th>基金代码</th>
                <th>基金名称</th>
                <th>估值涨幅</th>
                <th>预估收益</th>
                <th>最新净值</th>
                <th>日涨跌幅</th>
                <th>近半个月涨跌幅</th>
                <th>持仓金额</th>
                <th>持仓收益</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="fundTbody">
            <!-- 数据由JS动态渲染 -->
        </tbody>
    </table>

    <!-- 基金详情模态框 -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>基金详情</h2>
            <div class="loading-details" id="detailsLoading">加载中...</div>
            <div id="fundDetailsContent" style="display: none">
                <div class="fund-details">
                    <p><strong>基金代码：</strong><span id="detailCode"></span></p>
                    <p><strong>基金名称：</strong><span id="detailName"></span></p>
                    <p><strong>估值涨幅：</strong><span id="detailGszzl"></span></p>
                    <p><strong>最新净值：</strong><span id="detailDwjz"></span></p>
                    <p><strong>日涨跌幅：</strong><span id="detailZzl"></span></p>
                    <p><strong>净值日期：</strong><span id="detailJzrq"></span></p>
                    <p><strong>估值时间：</strong><span id="detailGztime"></span></p>
                </div>
                <h3>持仓详情</h3>
                <table class="holdings-table" id="holdingsTable">
                    <thead>
                        <tr>
                            <th>股票代码</th>
                            <th>股票名称</th>
                            <th>占比</th>
                            <th>涨跌幅</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsTbody">
                        <!-- 持仓数据由JS动态渲染 -->
                    </tbody>
                </table>

                <h3>我的持仓</h3>
                <div id="myHoldingsSection">
                    <div class="loading-details" id="holdingsLoading">加载中...</div>
                    <div id="holdingsContent" style="display: none">
                        <div class="fund-details">
                            <p><strong>持仓份额：</strong><span id="holdingShares"></span></p>
                            <p><strong>持仓成本：</strong><span id="holdingCost"></span></p>
                            <p><strong>持仓市值：</strong><span id="holdingValue"></span></p>
                            <p><strong>持仓收益：</strong><span id="estimatedProfit"></span></p>
                            <p><strong>收益比例：</strong><span id="profitRate"></span></p>
                        </div>

                        <h4>持仓操作</h4>
                        <div class="holding-operations">
                            <div class="operation-group">
                                <label for="operationType">操作类型：</label>
                                <select id="operationType" class="operation-select" onchange="toggleOperationFields()">
                                    <option value="add">加仓</option>
                                    <option value="reduce">减仓</option>
                                    <option value="modify">修改持仓</option>
                                </select>
                            </div>
                            <div class="operation-group" id="amountField">
                                <label for="operationAmount">金额（元）：</label>
                                <input type="number" id="operationAmount" min="1" step="0.01" placeholder="请输入金额">
                            </div>
                            <div class="operation-group" id="modifyFields" style="display: none">
                                <div class="operation-group">
                                    <label for="modifyValue">持仓金额（元）：</label>
                                    <input type="number" id="modifyValue" min="0" step="0.01" placeholder="请输入持仓金额">
                                </div>
                                <div class="operation-group">
                                    <label for="modifyProfit">持仓收益（元）：</label>
                                    <input type="number" id="modifyProfit" step="0.01" placeholder="请输入持仓收益">
                                </div>
                            </div>
                            <button class="confirm-btn" onclick="updateHoldings()">确认操作</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 禁用右键菜单
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        // 禁用F12、Ctrl+Shift+I等开发者工具快捷键
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
            }
        });

        // 登录验证
        // 定义多组账号密码数据
        const validUsers = [
            { username: 'admin', password: '123456' },
        ];

        // 登录函数
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');

            // 验证账号密码
            const isValid = validUsers.some(user =>
                user.username === username && user.password === password
            );

            if (isValid) {
                // 登录成功，隐藏登录界面
                document.getElementById('loginContainer').style.display = 'none';
            } else {
                // 登录失败，显示错误信息
                errorElement.style.display = 'block';
                // 3秒后隐藏错误信息
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 3000);
            }
        }

        // 存储基金代码列表（从本地存储加载，或使用空数组）
        let fundCodes = JSON.parse(localStorage.getItem('fundCodes')) || [];
        // 保存基金代码到本地存储
        localStorage.setItem('fundCodes', JSON.stringify(fundCodes));

        // 存储基金基本信息（代码和名称）
        let fundBaseInfo = {};
        // 存储上次刷新时间
        let lastRefreshTime = 0;
        const REFRESH_INTERVAL = 30000; // 30秒
        // 存储用户持仓数据
        let userHoldings = JSON.parse(localStorage.getItem('userHoldings')) || {};

        // 页面加载完成后自动获取一次数据
        window.onload = function () {
            initializeTable();
        };

        // 刷新数据函数（带节流）
        function refreshData() {
            // 检查基金列表是否为空
            if (fundCodes.length === 0) {
                return;
            }

            const now = Date.now();
            if (now - lastRefreshTime < REFRESH_INTERVAL) {
                // 30秒内重复点击，不触发刷新
                alert('刷新频率过高，请30秒后再试');
                return;
            }

            // 更新上次刷新时间
            lastRefreshTime = now;

            // 刷新数据
            updateEstimateRates();
        }

        // 初始化表格，只执行一次（串行请求，避免触发API限流）
        function initializeTable() {
            // 检查基金列表是否为空
            if (fundCodes.length === 0) {
                document.getElementById("loading").style.display = "none";
                document.getElementById("fundTable").style.display = "none";
                return;
            }

            // 清空表格、显示加载提示
            const tbody = document.getElementById("fundTbody");
            tbody.innerHTML = "";
            document.getElementById("loading").style.display = "block";
            document.getElementById("fundTable").style.display = "none";

            // 存储所有基金数据
            const fundDataList = [];
            let index = 0;

            // 串行请求每只基金的估值数据
            function requestNext() {
                if (index < fundCodes.length) {
                    const code = fundCodes[index];
                    getFundValuation(code, (data) => {
                        fundDataList.push(data);
                        // 存储基金基本信息
                        fundBaseInfo[data.code] = {
                            code: data.code,
                            name: data.name
                        };
                        index++;

                        // 所有请求完成后，按照fundCodes顺序渲染数据
                        if (index === fundCodes.length) {
                            renderInitialTable(fundDataList);
                        } else {
                            // 添加延迟后请求下一只基金，进一步减少请求频率
                            setTimeout(requestNext, 500);
                        }
                    });
                }
            }

            // 开始请求
            requestNext();
        }

        // 渲染初始表格
        function renderInitialTable(fundDataList) {
            const tbody = document.getElementById("fundTbody");

            // 按照fundCodes数组的顺序排序数据
            const sortedData = fundCodes.map(code => {
                return fundDataList.find(data => data.code === code) || {
                    code: code,
                    name: "--",
                    estimateRate: "--",
                    halfMonthRate: "--"
                };
            });

            // 渲染排序后的数据
            sortedData.forEach(data => {
                // 创建表格行
                const tr = document.createElement("tr");
                tr.id = `fund-row-${data.code}`;

                // 处理涨幅样式：涨绿（负号）、跌红（正号/无符号），空值显示--
                let rateClass = "";
                let rateText = data.estimateRate || "--";
                if (rateText !== "--") {
                    rateText = `${rateText}%`;
                    rateClass = rateText.startsWith("-") ? "fall" : "rise";
                }

                // 处理日涨跌幅样式
                let dayRateClass = "";
                let dayRateText = data.zzl || "--";
                if (dayRateText !== "--") {
                    dayRateText = `${dayRateText}%`;
                    dayRateClass = dayRateText.startsWith("-") ? "fall" : "rise";
                }

                // 处理近半个月涨跌幅样式
                let halfMonthRateClass = "";
                let halfMonthRateText = data.halfMonthRate || "--";
                if (halfMonthRateText !== "--") {
                    halfMonthRateClass = halfMonthRateText.startsWith("-") ? "fall" : "rise";
                }

                // 计算持仓金额和收益金额
                const holdings = userHoldings[data.code] || {
                    shares: 0,
                    cost: 0,
                    totalInvestment: 0
                };
                const currentNetValue = parseFloat(data.dwjz) || 0;
                const holdingValue = holdings.shares * currentNetValue;
                const profit = holdingValue - holdings.totalInvestment;

                // 计算预估收益（根据估值涨幅和持仓金额）
                const estimateRate = parseFloat(data.estimateRate) || 0;
                const estimatedProfit = holdingValue * (estimateRate / 100);
                let estimatedProfitClass = estimatedProfit >= 0 ? "rise" : "fall";

                // 处理收益金额样式
                let profitClass = profit >= 0 ? "rise" : "fall";

                // 拼接表格单元格（空值统一显示--，保证界面整洁）
                tr.innerHTML = `
                                    <td data-label="基金代码">${data.code || "--"}</td>
                                    <td data-label="基金名称">${data.name || "--"}</td>
                                    <td data-label="估值涨幅" class="${rateClass}" id="rate-${data.code}"><span>${rateText}</span></td>
                                    <td data-label="预估收益" class="${estimatedProfitClass}" id="estimated-profit-${data.code}"><span>${estimatedProfit >= 0 ? `+${estimatedProfit.toFixed(2)}` : estimatedProfit.toFixed(2)}</span></td>
                                    <td data-label="最新净值" id="dwjz-${data.code}"><span>${data.dwjz || "--"}</span></td>
                                    <td data-label="日涨跌幅" class="${dayRateClass}" id="zzl-${data.code}"><span>${dayRateText}</span></td>
                                    <td data-label="近半个月涨跌幅" class="${halfMonthRateClass}" id="halfmonth-rate-${data.code}"><span>${halfMonthRateText}</span></td>
                                    <td data-label="持仓金额" id="holding-value-${data.code}"><span>${holdingValue.toFixed(2)}</span></td>
                                    <td data-label="持仓收益" class="${profitClass}" id="profit-${data.code}"><span>${profit >= 0 ? `+${profit.toFixed(2)}` : profit.toFixed(2)}</span></td>
                                    <td data-label="操作"><button class="detail-btn" onclick="showFundDetails('${data.code}')">详情</button></td>
                            `;

                // 将行加入表格
                tbody.appendChild(tr);
            });

            // 隐藏加载提示，显示表格
            document.getElementById("loading").style.display = "none";
            document.getElementById("fundTable").style.display = "table";
        }

        // 更新估值涨幅数据（串行请求，避免触发API限流）
        function updateEstimateRates() {
            // 检查基金列表是否为空
            if (fundCodes.length === 0) {
                document.getElementById("loading").style.display = "none";
                return;
            }

            // 显示加载提示
            document.getElementById("loading").style.display = "block";

            let index = 0;
            let completedRequests = 0;

            function requestNext() {
                if (index < fundCodes.length) {
                    const code = fundCodes[index];
                    getFundValuation(code, (data) => {
                        // 只更新估值涨幅
                        updateSingleRate(data);
                        index++;
                        completedRequests++;

                        // 所有请求完成后，隐藏加载提示
                        if (completedRequests === fundCodes.length) {
                            document.getElementById("loading").style.display = "none";
                        }

                        // 添加延迟后请求下一只基金，进一步减少请求频率
                        setTimeout(requestNext, 300);
                    });
                }
            }

            requestNext();
        }

        // 核心：请求天天基金API，获取单只基金实时估值
        function getFundValuation(fundCode, callback) {
            // 天天基金公开估值API（jsonp格式，解决跨域问题，稳定免费）
            // 注意：API总是调用固定的jsonpgz回调函数
            const apiUrl = `https://fundgz.1234567.com.cn/js/${fundCode}.js?rt=${new Date().getTime()}`;

            // 创建script标签，通过jsonp方式请求（避免跨域，纯前端最佳方案）
            const script = document.createElement("script");
            script.src = apiUrl;
            script.charset = "utf-8";

            // 添加超时机制，3秒后自动调用回调函数
            const timeoutId = setTimeout(() => {
                // 使用之前存储的基金名称（如果有的话）
                const savedName = fundBaseInfo[fundCode] ? fundBaseInfo[fundCode].name : "--";
                callback({
                    code: fundCode,
                    name: savedName,
                    estimateRate: "--",
                    dwjz: "--",
                    zzl: null,
                    halfMonthRate: "--"
                });
                // 移除临时script标签
                if (document.body.contains(script)) {
                    document.body.removeChild(script);
                }
                // 恢复原始回调函数
                window.jsonpgz = originalCallback;
            }, 3000);

            // 使用闭包保存当前请求的参数，避免作用域问题
            const handleResponse = function (currentFundCode, currentCallback, originalCallback) {
                return function (data) {
                    // 清除超时
                    clearTimeout(timeoutId);

                    try {
                        // 检查data是否存在，避免因数据格式错误导致的异常
                        if (!data) {
                            // 使用之前存储的基金名称（如果有的话）
                            const savedName = fundBaseInfo[currentFundCode] ? fundBaseInfo[currentFundCode].name : "--";
                            currentCallback({
                                code: currentFundCode,
                                name: savedName,
                                estimateRate: "--",
                                dwjz: "--",
                                zzl: null,
                                halfMonthRate: "--"
                            });
                        } else {
                            // 解析API返回的核心数据
                            const fundData = {
                                code: data.fundcode || currentFundCode, // 基金代码
                                name: data.name || (fundBaseInfo[currentFundCode] ? fundBaseInfo[currentFundCode].name : "--"), // 基金名称
                                estimateRate: data.gszzl || "--", // 估值涨幅（%）
                                dwjz: data.dwjz || "--", // 最新净值
                                zzl: null, // 日涨跌幅
                                halfMonthRate: "--" // 近半个月涨跌幅
                            };

                            // 获取腾讯财经的日涨跌幅数据
                            const tUrl = `https://qt.gtimg.cn/q=jj${currentFundCode}`;
                            const tScript = document.createElement('script');
                            tScript.src = tUrl;
                            tScript.onload = function () {
                                const v = window[`v_jj${currentFundCode}`];
                                if (v) {
                                    const p = v.split('~');
                                    if (p.length > 7) {
                                        const zzl = parseFloat(p[7]);
                                        if (!isNaN(zzl)) {
                                            fundData.zzl = zzl;
                                        }
                                    }
                                }
                                // 移除脚本
                                if (document.body.contains(tScript)) {
                                    document.body.removeChild(tScript);
                                }

                                // 获取近半个月涨跌幅
                                getFundHistoryData(currentFundCode, (halfMonthRate) => {
                                    fundData.halfMonthRate = halfMonthRate;
                                    // 调用回调函数，传递数据
                                    currentCallback(fundData);
                                });
                            };
                            tScript.onerror = function () {
                                // 移除脚本
                                if (document.body.contains(tScript)) {
                                    document.body.removeChild(tScript);
                                }

                                // 获取近半个月涨跌幅
                                getFundHistoryData(currentFundCode, (halfMonthRate) => {
                                    fundData.halfMonthRate = halfMonthRate;
                                    // 调用回调函数，传递数据
                                    currentCallback(fundData);
                                });
                            };
                            document.body.appendChild(tScript);
                        }
                    } catch (error) {
                        // 捕获任何异常，确保回调函数能够正常执行
                        console.error('Error in jsonpgz callback:', error);
                        // 使用之前存储的基金名称（如果有的话）
                        const savedName = fundBaseInfo[currentFundCode] ? fundBaseInfo[currentFundCode].name : "--";
                        currentCallback({
                            code: currentFundCode,
                            name: savedName,
                            estimateRate: "--",
                            halfMonthRate: "--"
                        });
                    } finally {
                        // 移除临时script标签，避免冗余
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        // 恢复原始回调函数
                        window.jsonpgz = originalCallback;
                    }
                };
            };

            // 保存原始回调函数
            const originalCallback = window.jsonpgz;

            // 添加错误处理
            script.onerror = function () {
                // 清除超时
                clearTimeout(timeoutId);

                // 请求失败时，返回默认数据
                callback({
                    code: fundCode,
                    name: "--",
                    estimateRate: "--",
                    dwjz: "--",
                    zzl: null,
                    halfMonthRate: "--"
                });
                // 移除临时script标签
                if (document.body.contains(script)) {
                    document.body.removeChild(script);
                }
                // 恢复原始回调函数
                window.jsonpgz = originalCallback;
            };

            // 定义固定的回调函数，使用闭包保存参数
            window.jsonpgz = handleResponse(fundCode, callback, originalCallback);

            // 将script标签加入页面，发起请求
            document.body.appendChild(script);
        }

        // 获取基金历史数据，计算近半个月涨跌幅
        function getFundHistoryData(fundCode, callback) {
            // 计算日期范围：从昨天往前推25天，确保能获取到至少15个交易日
            const endDate = new Date();
            endDate.setDate(endDate.getDate() - 1); // 从昨天开始
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 25); // 往前推25天，确保包含至少15个交易日

            // 格式化日期为YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const startDateStr = formatDate(startDate);
            const endDateStr = formatDate(endDate);

            // 使用天天基金网的历史净值API
            const apiUrl = `https://fund.eastmoney.com/f10/F10DataApi.aspx?type=lsjz&code=${fundCode}&page=1&sdate=${startDateStr}&edate=${endDateStr}&per=30&rt=${new Date().getTime()}`;

            // 创建script标签，使用JSONP方式请求
            const script = document.createElement('script');
            script.src = apiUrl;
            script.charset = 'utf-8';

            // 保存原始的回调函数
            const originalCallback = window.DataCallback;

            // 定义回调函数
            window.DataCallback = function (data) {
                try {
                    if (data && data.content && data.content.length > 0) {
                        // 获取近10个交易日的净值数据
                        const content = data.content;
                        let halfMonthRate = "--";

                        // 解析HTML表格，提取净值数据
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(content, 'text/html');
                        const rows = doc.querySelectorAll('tbody tr');

                        // 如果有至少15个数据点，计算涨跌幅
                        if (rows.length >= 15) {
                            const latestNetValueStr = rows[0].querySelector('td:nth-child(2)').textContent;
                            const oldestNetValueStr = rows[14].querySelector('td:nth-child(2)').textContent;

                            const latestNetValue = parseFloat(latestNetValueStr);
                            const oldestNetValue = parseFloat(oldestNetValueStr);

                            if (!isNaN(latestNetValue) && !isNaN(oldestNetValue) && oldestNetValue > 0) {
                                const rate = ((latestNetValue - oldestNetValue) / oldestNetValue) * 100;
                                halfMonthRate = rate.toFixed(2) + "%";
                            }
                        }

                        callback(halfMonthRate);
                    } else {
                        callback("--");
                    }
                } catch (error) {
                    console.error('Error parsing fund history data:', error);
                    callback("--");
                } finally {
                    // 移除script标签
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    // 恢复原始回调函数
                    window.DataCallback = originalCallback;
                }
            };

            // 处理API直接定义apidata变量的情况
            script.onload = function () {
                try {
                    if (window.apidata) {
                        const data = window.apidata;
                        if (data && data.content && data.content.length > 0) {
                            // 获取近10个交易日的净值数据
                            const content = data.content;
                            let halfMonthRate = "--";

                            // 解析HTML表格，提取净值数据
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(content, 'text/html');
                            const rows = doc.querySelectorAll('tbody tr');

                            // 如果有至少15个数据点，计算涨跌幅
                            if (rows.length >= 15) {
                                const latestNetValueStr = rows[0].querySelector('td:nth-child(2)').textContent;
                                const oldestNetValueStr = rows[14].querySelector('td:nth-child(2)').textContent;

                                const latestNetValue = parseFloat(latestNetValueStr);
                                const oldestNetValue = parseFloat(oldestNetValueStr);

                                if (!isNaN(latestNetValue) && !isNaN(oldestNetValue) && oldestNetValue > 0) {
                                    const rate = ((latestNetValue - oldestNetValue) / oldestNetValue) * 100;
                                    halfMonthRate = rate.toFixed(2) + "%";
                                }
                            }

                            callback(halfMonthRate);
                        } else {
                            callback("--");
                        }
                    } else {
                        callback("--");
                    }
                } catch (error) {
                    console.error('Error parsing fund history data:', error);
                    callback("--");
                } finally {
                    // 移除script标签
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    // 清理全局变量
                    delete window.apidata;
                }
            };

            // 添加错误处理
            script.onerror = function () {
                console.error('Error loading fund history data:', fundCode);
                callback("--");
                // 移除script标签
                if (document.body.contains(script)) {
                    document.body.removeChild(script);
                }
                // 恢复原始回调函数
                window.DataCallback = originalCallback;
            };

            // 添加到页面
            document.body.appendChild(script);
        }

        // 更新单个基金的估值涨幅
        function updateSingleRate(data) {
            // 处理涨幅样式：涨绿（负号）、跌红（正号/无符号），空值显示--
            let rateClass = "";
            let rateText = data.estimateRate || "--";
            if (rateText !== "--") {
                rateText = `${rateText}%`;
                rateClass = rateText.startsWith("-") ? "fall" : "rise";
            }

            // 更新估值涨幅单元格
            const rateCell = document.getElementById(`rate-${data.code}`);
            if (rateCell) {
                rateCell.textContent = rateText;
                rateCell.className = rateClass;
            }

            // 更新最新净值
            if (data.dwjz) {
                const dwjzCell = document.getElementById(`dwjz-${data.code}`);
                if (dwjzCell) {
                    dwjzCell.textContent = data.dwjz;
                }
            }

            // 更新日涨跌幅
            if (data.zzl) {
                let dayRateClass = "";
                let dayRateText = data.zzl || "--";
                if (dayRateText !== "--") {
                    dayRateText = `${dayRateText}%`;
                    dayRateClass = dayRateText.startsWith("-") ? "fall" : "rise";
                }
                const zzlCell = document.getElementById(`zzl-${data.code}`);
                if (zzlCell) {
                    zzlCell.textContent = dayRateText;
                    zzlCell.className = dayRateClass;
                }
            }

            // 更新近半个月涨跌幅单元格
            if (data.halfMonthRate) {
                let halfMonthRateClass = "";
                let halfMonthRateText = data.halfMonthRate || "--";
                if (halfMonthRateText !== "--") {
                    halfMonthRateClass = halfMonthRateText.startsWith("-") ? "fall" : "rise";
                }
                const halfMonthRateCell = document.getElementById(`halfmonth-rate-${data.code}`);
                if (halfMonthRateCell) {
                    halfMonthRateCell.textContent = halfMonthRateText;
                    halfMonthRateCell.className = halfMonthRateClass;
                }
            }

            // 更新基金名称（如果有新数据）
            if (data.name && data.name !== "--") {
                // 无论之前存储的是什么，都更新为新的基金名称
                fundBaseInfo[data.code] = {
                    code: data.code,
                    name: data.name
                };
                // 更新表格中的基金名称
                const row = document.getElementById(`fund-row-${data.code}`);
                if (row && row.cells[1]) {
                    row.cells[1].textContent = data.name;
                }
            }

            // 更新持仓金额和收益金额
            const holdings = userHoldings[data.code] || {
                shares: 0,
                cost: 0,
                totalInvestment: 0
            };
            const currentNetValue = parseFloat(data.dwjz) || 0;
            const holdingValue = holdings.shares * currentNetValue;
            const profit = holdingValue - holdings.totalInvestment;

            // 计算预估收益（根据估值涨幅和持仓金额）
            const estimateRate = parseFloat(data.estimateRate) || 0;
            const estimatedProfit = holdingValue * (estimateRate / 100);
            const estimatedProfitClass = estimatedProfit >= 0 ? "rise" : "fall";

            // 更新预估收益
            const estimatedProfitCell = document.getElementById(`estimated-profit-${data.code}`);
            if (estimatedProfitCell) {
                estimatedProfitCell.textContent = estimatedProfit >= 0 ? `+${estimatedProfit.toFixed(2)}` : estimatedProfit.toFixed(2);
                estimatedProfitCell.className = estimatedProfitClass;
            }

            // 更新持仓金额
            const holdingValueCell = document.getElementById(`holding-value-${data.code}`);
            if (holdingValueCell) {
                holdingValueCell.textContent = holdingValue.toFixed(2);
            }

            // 更新收益金额
            const profitCell = document.getElementById(`profit-${data.code}`);
            if (profitCell) {
                const profitClass = profit >= 0 ? "rise" : "fall";
                profitCell.textContent = profit >= 0 ? `+${profit.toFixed(2)}` : profit.toFixed(2);
                profitCell.className = profitClass;
            }

            // 更新用户持仓收益（如果有持仓）
            if (userHoldings[data.code]) {
                loadUserHoldings(data.code, data.dwjz);
            }
        }

        // 显示基金详情模态框
        function showFundDetails(fundCode) {
            // 显示模态框
            document.getElementById('fundModal').style.display = 'block';
            document.getElementById('detailsLoading').style.display = 'block';
            document.getElementById('fundDetailsContent').style.display = 'none';

            // 获取基金详情数据
            fetchFundData(fundCode).then(data => {
                // 填充基金基本信息
                document.getElementById('detailCode').textContent = data.code || '--';
                document.getElementById('detailName').textContent = data.name || '--';
                document.getElementById('detailGszzl').textContent = data.gszzl ? `${data.gszzl}%` : '--';
                document.getElementById('detailDwjz').textContent = data.dwjz || '--';
                document.getElementById('detailZzl').textContent = data.zzl ? `${data.zzl}%` : '--';
                document.getElementById('detailJzrq').textContent = data.jzrq || '--';
                document.getElementById('detailGztime').textContent = data.gztime || '--';

                // 填充持仓信息
                const holdingsTbody = document.getElementById('holdingsTbody');
                holdingsTbody.innerHTML = '';

                if (data.holdings && data.holdings.length > 0) {
                    data.holdings.forEach(holding => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
              <td>${holding.code || '--'}</td>
              <td>${holding.name || '--'}</td>
              <td>${holding.weight || '--'}</td>
              <td>${holding.change ? `${holding.change}%` : '--'}</td>
            `;
                        holdingsTbody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4">暂无持仓数据</td>';
                    holdingsTbody.appendChild(row);
                }

                // 加载用户持仓信息
                loadUserHoldings(data.code, data.dwjz);

                // 显示内容，隐藏加载提示
                document.getElementById('detailsLoading').style.display = 'none';
                document.getElementById('fundDetailsContent').style.display = 'block';
            }).catch(error => {
                console.error('Error fetching fund details:', error);
                document.getElementById('detailsLoading').innerHTML = '加载失败，请重试';
            });
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('fundModal').style.display = 'none';
        }

        // 点击模态框外部关闭
        window.onclick = function (event) {
            const modal = document.getElementById('fundModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // 加载用户持仓信息
        function loadUserHoldings(fundCode, currentNetValue) {
            document.getElementById('holdingsLoading').style.display = 'block';
            document.getElementById('holdingsContent').style.display = 'none';

            // 获取用户持仓数据
            const holdings = userHoldings[fundCode] || {
                shares: 0,
                cost: 0,
                totalInvestment: 0
            };

            // 计算持仓市值和收益
            const currentValue = holdings.shares * parseFloat(currentNetValue || 0);
            const profit = currentValue - holdings.totalInvestment;
            const profitRate = holdings.totalInvestment > 0 ? (profit / holdings.totalInvestment) * 100 : 0;

            // 填充持仓信息
            document.getElementById('holdingShares').textContent = holdings.shares.toFixed(4);
            document.getElementById('holdingCost').textContent = holdings.cost.toFixed(4);
            document.getElementById('holdingValue').textContent = currentValue.toFixed(2);

            // 显示收益（红色为负，绿色为正）
            const profitElement = document.getElementById('estimatedProfit');
            const rateElement = document.getElementById('profitRate');

            if (profit >= 0) {
                profitElement.textContent = `+${profit.toFixed(2)}`;
                profitElement.style.color = '#ff4757';
                rateElement.textContent = `+${profitRate.toFixed(2)}%`;
                rateElement.style.color = '#ff4757';
            } else {
                profitElement.textContent = profit.toFixed(2);
                profitElement.style.color = '#00ff88';
                rateElement.textContent = `${profitRate.toFixed(2)}%`;
                rateElement.style.color = '#00ff88';
            }

            // 显示持仓内容
            document.getElementById('holdingsLoading').style.display = 'none';
            document.getElementById('holdingsContent').style.display = 'block';
        }

        // 切换操作类型字段
        function toggleOperationFields() {
            const operationType = document.getElementById('operationType').value;
            const amountField = document.getElementById('amountField');
            const modifyFields = document.getElementById('modifyFields');

            if (operationType === 'modify') {
                // 显示修改持仓字段，隐藏金额字段
                amountField.style.display = 'none';
                modifyFields.style.display = 'block';

                // 填充当前持仓数据到修改字段
                const fundCode = document.getElementById('detailCode').textContent;
                const currentNetValue = parseFloat(document.getElementById('detailDwjz').textContent) || 0;
                const holdings = userHoldings[fundCode] || {
                    shares: 0,
                    cost: 0,
                    totalInvestment: 0
                };

                // 计算当前持仓金额和收益金额
                const currentValue = holdings.shares * currentNetValue;
                const profit = currentValue - holdings.totalInvestment;

                document.getElementById('modifyValue').value = currentValue.toFixed(2);
                document.getElementById('modifyProfit').value = profit.toFixed(2);
            } else {
                // 显示金额字段，隐藏修改持仓字段
                amountField.style.display = 'block';
                modifyFields.style.display = 'none';
            }
        }

        // 更新持仓（加仓/减仓/修改）
        function updateHoldings() {
            const fundCode = document.getElementById('detailCode').textContent;
            const currentNetValue = parseFloat(document.getElementById('detailDwjz').textContent) || 0;
            const operationType = document.getElementById('operationType').value;

            let holdings = userHoldings[fundCode] || {
                shares: 0,
                cost: 0,
                totalInvestment: 0
            };

            if (operationType === 'add') {
                // 加仓
                const amount = parseFloat(document.getElementById('operationAmount').value) || 0;

                if (amount <= 0) {
                    alert('请输入有效的金额');
                    return;
                }

                if (currentNetValue <= 0) {
                    alert('无法获取当前净值，操作失败');
                    return;
                }

                const newShares = amount / currentNetValue;
                const newTotalInvestment = holdings.totalInvestment + amount;
                const newCost = newTotalInvestment / (holdings.shares + newShares);

                holdings = {
                    shares: holdings.shares + newShares,
                    cost: newCost,
                    totalInvestment: newTotalInvestment
                };
            } else if (operationType === 'reduce') {
                // 减仓
                const amount = parseFloat(document.getElementById('operationAmount').value) || 0;

                if (amount <= 0) {
                    alert('请输入有效的金额');
                    return;
                }

                if (currentNetValue <= 0) {
                    alert('无法获取当前净值，操作失败');
                    return;
                }

                const reduceShares = amount / currentNetValue;

                if (reduceShares > holdings.shares) {
                    alert('减仓份额不能超过持仓份额');
                    return;
                }

                const newShares = holdings.shares - reduceShares;
                const newTotalInvestment = holdings.totalInvestment - amount;

                holdings = {
                    shares: newShares,
                    cost: holdings.cost, // 成本价不变
                    totalInvestment: newTotalInvestment
                };
            } else if (operationType === 'modify') {
                // 修改持仓
                const modifyValue = parseFloat(document.getElementById('modifyValue').value) || 0;
                const modifyProfit = parseFloat(document.getElementById('modifyProfit').value) || 0;

                if (modifyValue < 0) {
                    alert('请输入有效的持仓金额');
                    return;
                }

                // 计算总投资额
                const totalInvestment = modifyValue - modifyProfit;

                if (totalInvestment < 0) {
                    alert('总投资额不能为负数');
                    return;
                }

                // 计算份额和成本
                let shares = 0;
                let cost = 0;

                if (currentNetValue > 0) {
                    shares = modifyValue / currentNetValue;
                    cost = totalInvestment / shares;
                }

                holdings = {
                    shares: shares,
                    cost: cost,
                    totalInvestment: totalInvestment
                };
            }

            // 保存持仓数据
            userHoldings[fundCode] = holdings;
            localStorage.setItem('userHoldings', JSON.stringify(userHoldings));

            // 重新加载持仓信息
            loadUserHoldings(fundCode, currentNetValue);

            // 更新列表中的持仓金额和收益金额
            const currentNetValueForUpdate = parseFloat(document.getElementById('detailDwjz').textContent) || 0;
            const updatedHoldingValue = holdings.shares * currentNetValueForUpdate;
            const updatedProfit = updatedHoldingValue - holdings.totalInvestment;

            // 更新持仓金额
            const holdingValueCell = document.getElementById(`holding-value-${fundCode}`);
            if (holdingValueCell) {
                holdingValueCell.textContent = updatedHoldingValue.toFixed(2);
            }

            // 更新收益金额
            const profitCell = document.getElementById(`profit-${fundCode}`);
            if (profitCell) {
                const profitClass = updatedProfit >= 0 ? "rise" : "fall";
                profitCell.textContent = updatedProfit >= 0 ? `+${updatedProfit.toFixed(2)}` : updatedProfit.toFixed(2);
                profitCell.className = profitClass;
            }

            // 更新预估收益
            const rateCell = document.getElementById(`rate-${fundCode}`);
            if (rateCell) {
                const estimateRateText = rateCell.textContent.replace('%', '');
                const estimateRate = parseFloat(estimateRateText) || 0;
                const estimatedProfit = updatedHoldingValue * (estimateRate / 100);
                const estimatedProfitClass = estimatedProfit >= 0 ? "rise" : "fall";

                const estimatedProfitCell = document.getElementById(`estimated-profit-${fundCode}`);
                if (estimatedProfitCell) {
                    estimatedProfitCell.textContent = estimatedProfit >= 0 ? `+${estimatedProfit.toFixed(2)}` : estimatedProfit.toFixed(2);
                    estimatedProfitCell.className = estimatedProfitClass;
                }
            }

            // 清空操作金额
            if (operationType !== 'modify') {
                document.getElementById('operationAmount').value = '';
            }

            alert('操作成功！');
        }

        // 搜索基金
        function searchFunds() {
            const searchTerm = document.getElementById('fundSearch').value.trim();
            if (!searchTerm) {
                alert('请输入基金代码或名称');
                return;
            }

            // 调用东方财富的基金搜索API
            const callbackName = `SuggestData_${Date.now()}`;
            const url = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(searchTerm)}&callback=${callbackName}&_=${Date.now()}`;

            // 创建script标签
            const script = document.createElement('script');
            script.src = url;

            // 定义回调函数
            window[callbackName] = function (data) {
                try {
                    const results = data?.Datas || [];
                    const searchResultsContainer = document.getElementById('searchResults');
                    searchResultsContainer.innerHTML = '';

                    if (results.length > 0) {
                        results.forEach(item => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.innerHTML = `
                <div class="search-result-info">
                  <span class="search-result-code">${item.CODE}</span>
                  <span class="search-result-name">${item.NAME}</span>
                </div>
                <button class="add-fund-btn" onclick="addFund('${item.CODE}', '${item.NAME}')">添加</button>
              `;
                            searchResultsContainer.appendChild(resultItem);
                        });
                        searchResultsContainer.style.display = 'block';
                    } else {
                        searchResultsContainer.innerHTML = '<div class="search-result-item">未找到相关基金</div>';
                        searchResultsContainer.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error processing search results:', error);
                } finally {
                    // 清理
                    delete window[callbackName];
                    document.body.removeChild(script);
                }
            };

            // 错误处理
            script.onerror = function () {
                console.error('Error searching funds');
                delete window[callbackName];
                document.body.removeChild(script);
            };

            // 添加到页面
            document.body.appendChild(script);
        }

        // 添加基金到列表
        function addFund(code, name) {
            if (!fundCodes.includes(code)) {
                fundCodes.push(code);
                localStorage.setItem('fundCodes', JSON.stringify(fundCodes));
                // 保存基金基本信息
                fundBaseInfo[code] = { code, name };
                // 重新初始化表格
                initializeTable();
                alert('基金添加成功！');
            } else {
                alert('该基金已在列表中');
            }
            // 隐藏搜索结果
            document.getElementById('searchResults').style.display = 'none';
        }

        // 获取基金详情数据
        function fetchFundData(fundCode) {
            return new Promise((resolve, reject) => {
                // 添加超时机制，5秒后自动resolve
                const timeoutId = setTimeout(() => {
                    resolve({
                        code: fundCode,
                        name: "--",
                        estimateRate: "--",
                        gszzl: "--",
                        dwjz: "--",
                        zzl: null,
                        jzrq: "--",
                        gztime: "--",
                        halfMonthRate: "--",
                        holdings: []
                    });
                }, 5000);

                // 获取基本估值数据
                getFundValuation(fundCode, (valuationData) => {
                    // 清除超时
                    clearTimeout(timeoutId);

                    // 获取持仓数据
                    fetchFundHoldings(fundCode).then(holdingsData => {
                        resolve({
                            ...valuationData,
                            gszzl: valuationData.estimateRate, // 确保有 gszzl 字段
                            jzrq: "--", // 添加默认值
                            gztime: "--", // 添加默认值
                            holdings: holdingsData
                        });
                    }).catch(() => {
                        resolve({
                            ...valuationData,
                            gszzl: valuationData.estimateRate, // 确保有 gszzl 字段
                            jzrq: "--", // 添加默认值
                            gztime: "--", // 添加默认值
                            holdings: []
                        });
                    });
                });
            });
        }

        // 获取基金持仓数据
        function fetchFundHoldings(fundCode) {
            return new Promise((resolve, reject) => {
                const url = `https://fund.eastmoney.com/f10/FundArchivesDatas.aspx?type=jjcc&code=${fundCode}&topline=10&year=&month=&rt=${Date.now()}`;

                const script = document.createElement('script');
                script.src = url;

                // 添加超时机制，3秒后自动resolve
                const timeoutId = setTimeout(() => {
                    delete window['FundArchivesDatas'];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    resolve([]);
                }, 3000);

                window['FundArchivesDatas'] = function (data) {
                    // 清除超时
                    clearTimeout(timeoutId);

                    try {
                        if (data && data.content) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(data.content, 'text/html');
                            const rows = doc.querySelectorAll('table tbody tr');

                            const holdings = [];
                            rows.forEach(row => {
                                const cells = row.querySelectorAll('td');
                                if (cells.length >= 4) {
                                    const code = cells[1].textContent.trim();
                                    const name = cells[0].textContent.trim();
                                    const weight = cells[2].textContent.trim();
                                    const change = cells[3].textContent.trim();

                                    holdings.push({ code, name, weight, change });
                                }
                            });

                            resolve(holdings);
                        } else {
                            resolve([]);
                        }
                    } catch (error) {
                        console.error('Error parsing holdings data:', error);
                        resolve([]);
                    } finally {
                        delete window['FundArchivesDatas'];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                    }
                };

                script.onerror = function () {
                    // 清除超时
                    clearTimeout(timeoutId);

                    console.error('Error fetching holdings data');
                    delete window['FundArchivesDatas'];
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                    resolve([]);
                };

                document.body.appendChild(script);
            });
        }
    </script>
</body>

</html>